import android.Manifest
import android.content.Intent
import android.content.pm.PackageManager
import android.location.Location
import android.location.LocationListener
import android.location.LocationManager
import android.net.Uri
import android.os.Bundle
import android.speech.RecognitionListener
import android.speech.RecognizerIntent
import android.speech.SpeechRecognizer
import android.speech.tts.TextToSpeech
import android.util.Log
import android.widget.Button
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import androidx.core.app.ActivityCompat
import androidx.core.content.ContextCompat
import java.util.Locale

class MainActivity : AppCompatActivity() {

    private lateinit var tts: TextToSpeech
    private lateinit var speechRecognizer: SpeechRecognizer
    private lateinit var locationManager: LocationManager
    private val RECORD_AUDIO_PERMISSION = 101
    private val LOCATION_PERMISSION = 102

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        // Inicializa o botão de voz
        val falarBtn: Button = findViewById(R.id.falar_btn)
        falarBtn.setOnClickListener {
            checkPermissions()
        }

        // Inicializa o motor de voz (TextToSpeech)
        tts = TextToSpeech(this) { status ->
            if (status != TextToSpeech.ERROR) {
                tts.language = Locale("pt", "BR")
                falarComMotorista("E aí, meu! O que você precisa?")
            }
        }

        // Inicializa o reconhecedor de fala
        speechRecognizer = SpeechRecognizer.createSpeechRecognizer(this)
        speechRecognizer.setRecognitionListener(object : RecognitionListener {
            override fun onReadyForSpeech(params: Bundle?) {
                Toast.makeText(this@MainActivity, "Estou ouvindo...", Toast.LENGTH_SHORT).show()
            }
            // AQUI O CÓDIGO PEGA O RESULTADO DA VOZ
            override fun onResults(results: Bundle?) {
                val matches = results?.getStringArrayList(SpeechRecognizer.RESULTS_RECOGNITION)
                if (matches != null && matches.isNotEmpty()) {
                    val comando = matches[0].toLowerCase(Locale("pt", "BR"))
                    processarComando(comando)
                }
            }
            override fun onEndOfSpeech() {}
            override fun onError(error: Int) {
                Log.e("SpeechRecognizer", "Erro: $error")
                falarComMotorista("Eita, não entendi. Tente novamente.")
            }
            override fun onBeginningOfSpeech() {}
            override fun onEvent(eventType: Int, params: Bundle?) {}
            override fun onPartialResults(partialResults: Bundle?) {}
            override fun onRmsChanged(rmsdB: Float) {}
            override fun onBufferReceived(buffer: ByteArray?) {}
        })
    }

    private fun checkPermissions() {
        if (ContextCompat.checkSelfPermission(this, Manifest.permission.RECORD_AUDIO) != PackageManager.PERMISSION_GRANTED) {
            ActivityCompat.requestPermissions(this, arrayOf(Manifest.permission.RECORD_AUDIO), RECORD_AUDIO_PERMISSION)
        } else {
            startListening()
        }
    }

    private fun startListening() {
        val intent = Intent(RecognizerIntent.ACTION_RECOGNIZE_SPEECH)
        intent.putExtra(RecognizerIntent.EXTRA_LANGUAGE_MODEL, RecognizerIntent.LANGUAGE_MODEL_FREE_FORM)
        intent.putExtra(RecognizerIntent.EXTRA_LANGUAGE, "pt-BR")
        speechRecognizer.startListening(intent)
    }

    private fun falarComMotorista(texto: String) {
        tts.speak(texto, TextToSpeech.QUEUE_FLUSH, null, "")
    }

    private fun processarComando(comando: String) {
        // Lógica de comando para abrir o mapa, tempo, etc.
        when {
            comando.contains("calcular tempo para") || comando.contains("me leve para") -> {
                val destino = comando.substringAfter("para ").trim()
                if (destino.isNotEmpty()) {
                    falarComMotorista("Calculando o tempo de viagem para $destino.")
                    val uri = Uri.parse("https://www.google.com/maps/dir/?api=1&destination=${Uri.encode(destino)}")
                    val mapIntent = Intent(Intent.ACTION_VIEW, uri)
                    startActivity(mapIntent)
                } else {
                    falarComMotorista("Pra onde você quer ir? Preciso de um destino, sô!")
                }
            }
            comando.contains("previsão do tempo para") || comando.contains("tempo em") -> {
                val cidade = if (comando.contains("previsão do tempo para")) {
                    comando.substringAfter("para ").trim()
                } else {
                    comando.substringAfter("em ").trim()
                }
                if (cidade.isNotEmpty()) {
                    falarComMotorista("Beleza! Olhando a previsão do tempo para $cidade.")
                    val uri = Uri.parse("https://www.google.com/search?q=previsão+do+tempo+em+${Uri.encode(cidade)}")
                    val webIntent = Intent(Intent.ACTION_VIEW, uri)
                    startActivity(webIntent)
                } else {
                    falarComMotorista("De qual cidade você quer saber a previsão do tempo?")
                }
            }
            comando.contains("onde eu estou") || comando.contains("qual a minha localização") -> {
                falarComMotorista("Beleza! Procurando sua localização agora.")
                if (ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION) != PackageManager.PERMISSION_GRANTED) {
                    ActivityCompat.requestPermissions(this, arrayOf(Manifest.permission.ACCESS_FINE_LOCATION), LOCATION_PERMISSION)
                } else {
                    // Pega a localização do usuário
                    locationManager = getSystemService(LOCATION_SERVICE) as LocationManager
                    val locationListener = object : LocationListener {
                        override fun onLocationChanged(location: Location) {
                            falarComMotorista("Encontrei! Abrindo o mapa com sua localização atual.")
                            val uri = Uri.parse("https://www.google.com/maps/@${location.latitude},${location.longitude},15z")
                            val mapIntent = Intent(Intent.ACTION_VIEW, uri)
                            startActivity(mapIntent)
                            locationManager.removeUpdates(this) // Remove o listener depois de encontrar a localização
                        }
                    }
                    locationManager.requestLocationUpdates(LocationManager.GPS_PROVIDER, 0, 0f, locationListener)
                }
            }
            comando.contains("o que tem na frente") -> {
                falarComMotorista("Tem um radar a duzentos metros. Cuidado com a velocidade!")
            }
            comando.contains("tocar uma música") -> {
                falarComMotorista("Beleza! Tocando 'Moda de Viola' agora.")
            }
            comando.contains("preciso descansar") -> {
                falarComMotorista("É pra já! O próximo posto de gasolina fica a dez quilômetros.")
            }
            comando.contains("desligar") || comando.contains("tchau") -> {
                falarComMotorista("Fechado! Boa viagem e até a próxima, meu.")
                finish()
            }
            else -> {
                falarComMotorista("Não entendi o que você disse. Pode repetir, por favor?")
            }
        }
    }
}
